<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<th:block>
    <h2>Chapter6. Tool Calling</h2><br>
    <p>도구 호출 ( 함수 호출 이라고도 함 )은 AI 애플리케이션에서 흔히 볼 수 있는 패턴으로, 모델이 일련의 API나 도구 와 상호 작용하여 기능을 확장할 수 있도록 해줍니다.</p>
    <p>도구는 주로 다음과 같은 용도로 사용됩니다.</p>
    <ul>
        <li>정보 검색 . 이 범주의 도구는 데이터베이스, 웹 서비스, 파일 시스템 또는 웹 검색 엔진과 같은 외부 소스에서 정보를 검색하는 데 사용할 수 있습니다. 이 도구의 목표는 모델의 지식을 증강하여 다른 방법으로는 답할 수 없는 질문에 답할 수 있도록 하는 것입니다. 따라서 이러한 도구는 검색 증강 생성(RAG) 시나리오에서 사용될 수 있습니다. 예를 들어, 도구를 사용하여 특정 위치의 현재 날씨를 검색하거나, 최신 뉴스 기사를 검색하거나, 데이터베이스에서 특정 레코드를 쿼리할 수 있습니다.</li>
        <li>조치 취하기 . 이 범주의 도구는 소프트웨어 시스템에서 이메일 전송, 데이터베이스에 새 레코드 생성, 양식 제출, 워크플로 트리거 등 특정 작업을 수행하는 데 사용할 수 있습니다. 이 도구의 목표는 사람의 개입이나 명시적인 프로그래밍이 필요한 작업을 자동화하는 것입니다. 예를 들어, 챗봇과 상호 작용하는 고객을 위해 항공편을 예약하거나, 웹 페이지에서 양식을 작성하거나, 코드 생성 시나리오에서 자동화된 테스트(TDD) 기반 Java 클래스를 구현하는 데 도구를 사용할 수 있습니다.</li>
        <li><span><a href="https://docs.spring.io/spring-ai/reference/api/tools.html">SpringAi 참고</a></span></li>
    </ul>
    <h4>1. 개요</h4>
    <p>Spring AI는 일관된 방식으로 도구를 정의, 해결 및 실행할 수 있도록 하는 유연한 추상화 집합을 통해 도구 호출을 지원합니다. 이 섹션에서는 Spring AI에서 도구 호출의 주요 개념과 구성 요소를 간략하게 설명합니다.</p>
    <img th:src="@{/imgs/tools1.png}" width="600px;"><br><a href="https://docs.spring.io/spring-ai/reference/api/tools.html">출처:docs.springai.io</a><br><br>
    <ol>
        <li>모델에서 도구를 사용할 수 있도록 하려면 채팅 요청에 해당 도구의 정의를 포함합니다. 각 도구 정의는 이름, 설명, 그리고 입력 매개변수의 스키마로 구성됩니다.</li>
        <li>모델이 도구를 호출하기로 결정하면 정의된 스키마에 따라 모델링된 도구 이름과 입력 매개변수가 포함된 응답을 보냅니다.</li>
        <li>애플리케이션은 제공된 입력 매개변수를 사용하여 도구를 식별하고 실행하기 위해 도구 이름을 사용합니다.</li>
        <li>도구 호출 결과는 애플리케이션에 의해 처리됩니다.</li>
        <li>애플리케이션은 도구 호출 결과를 모델로 다시 전송합니다.</li>
        <li>모델은 도구 호출 결과를 추가 컨텍스트로 사용하여 최종 응답을 생성합니다.</li>
        <li><span><a href="https://docs.spring.io/spring-ai/reference/api/tools.html">SpringAi 참고</a></span></li>
    </ol><br>
    <h4>2. 도구를 사용하는 방법</h4>
    <p>Spring AI는 도구(tools)를 사용한는 방법을 다음과 같은 두가지 방법을 제공 합니다.</p>
    <ul>
        <li>선언적으로, @Tool주석을 사용하여</li>
        <li>프로그래밍 방식으로 저수준 MethodToolCallback구현을 사용합니다.</li>
    </ul><br>
    <h4>3.  @ToolParam을 사용하면 도구 매개변수 전달.</h4>
    <p>Spring AI는 메서드의 입력 매개변수에 대한 JSON 스키마를 자동으로 생성합니다. 모델은 이 스키마를 사용하여 도구를 호출하고 도구 요청을 준비하는 방법을 파악합니다. 어노테이션은 @ToolParam매개변수에 대한 설명이나 매개변수가 필수인지 선택인지 여부와 같은 입력 매개변수에 대한 추가 정보를 제공하는 데 사용할 수 있습니다. 기본적으로 모든 입력 매개변수는 필수로 간주됩니다.</p>
    <pre style="border:1px solid cornflowerblue">

        @Tool(description = """
            사용자가 요구하는 지역의 시간 별 일기 예보를 가지고 옵니다.
            지역 이름을 기반으로 latitude, longitude 정보를 조회 해서 날씨 정보를 가지고 옵니다,
            """)
        String getForecastWeather(@ToolParam(description = "latitude", required = true) double latitude,
                                  @ToolParam(description = "longitude", required = true) double longitude) {
            return forecastWeatherService.getForecastWeather(latitude, longitude);
        }
    </pre>
    <ul>
        <li>description: 모델이 매개변수의 사용 방법을 더 잘 이해하는 데 사용할 수 있는 매개변수에 대한 설명입니다. 예를 들어, 매개변수의 형식, 허용되는 값 등이 있습니다.</li>
        <li>required: 매개변수가 필수인지 선택 사항인지 여부입니다. 기본적으로 모든 매개변수는 필수로 간주됩니다.</li>
    </ul><br>
    <h4>4. Tool Context</h4>
    <p>Spring AI는 API를 통해 도구에 추가적인 상황 정보를 전달하는 기능을 지원합니다 ToolContext. 이 기능을 사용하면 AI 모델에서 전달된 도구 인수와 함께 도구 실행 과정에서 사용할 수 있는 사용자 제공 데이터를 추가로 제공할 수 있습니다.</p>
    <img th:src="@{/imgs/tools2.png}" width="600px;"><br><a href="https://docs.spring.io/spring-ai/reference/api/tools.html">출처:docs.springai.io</a><br><br>
    <pre style="border:1px solid cornflowerblue">

        @Tool(description = "특정 ID 사용자의 구매 목록을 조회. ")
        List&lt;Shop&gt; getOrderedByCustomer(ToolContext toolContext) {
            String userId = (String) toolContext.getContext().get("userId");
            return shoppingService.getOrderedByCustomer(userId);
        }
    </pre>
    <h4>5. Return Direct</h4>
    <p>결과를 모델로 다시 보내는 대신 호출자에게 직접 반환하는 것이 더 나을 수 있습니다. 예를 들어, RAG 도구를 사용하는 에이전트를 빌드하는 경우, 불필요한 후처리를 위해 모델로 다시 보내는 대신 호출자에게 직접 결과를 반환하는 것이 좋습니다. 또는 에이전트의 추론 루프를 종료하는 특정 도구가 있을 수도 있습니다.</p>
    <img th:src="@{/imgs/tools3.png}" width="600px;"><br><a href="https://docs.spring.io/spring-ai/reference/api/tools.html">출처:docs.springai.io</a><br><br>

    <ol>
        <li>모델에서 도구를 사용할 수 있도록 하려면 채팅 요청에 해당 도구의 정의를 포함합니다. 도구 실행 결과를 호출자에게 직접 반환하려면 속성을 . returnDirect로 설정합니다 true.</li>
        <li>모델이 도구를 호출하기로 결정하면 정의된 스키마에 따라 모델링된 도구 이름과 입력 매개변수가 포함된 응답을 보냅니다.</li>
        <li>애플리케이션은 제공된 입력 매개변수를 사용하여 도구를 식별하고 실행하기 위해 도구 이름을 사용합니다.</li>
        <li>도구 호출 결과는 애플리케이션에 의해 처리됩니다.</li>
        <li>애플리케이션은 모델로 다시 전송하는 대신 도구 호출 결과를 호출자에게 직접 전송합니다.</li>
        <li><span><a href="https://docs.spring.io/spring-ai/reference/api/tools.html">SpringAi 참고</a></span></li>
    </ol>
    <h4>6. Exception Handling</h4>
    <p>도구 호출이 실패하면 예외는 a로 전파되며, ToolExecutionException이를 catch하여 오류를 처리할 수 있습니다. A는 ToolExecutionExceptionProcessora를 처리하는 데 사용할 수 있으며, ToolExecutionException두 가지 결과가 발생합니다. AI 모델로 다시 전송할 오류 메시지를 생성하거나, 호출자가 처리할 예외를 throw합니다.</p>
    <p>Spring AI Spring Boot Starters를 사용하는 경우, 는 인터페이스 DefaultToolExecutionExceptionProcessor의 자동 구성 구현입니다 ToolExecutionExceptionProcessor. 기본적으로 의 오류 메시지는 RuntimeException모델로 다시 전송되지만, 확인된 예외와 오류(예: IOException, OutOfMemoryError)는 항상 throw됩니다. 생성자를 사용하면 속성 을 로 DefaultToolExecutionExceptionProcessor설정할 수 있습니다 . 로 설정하면 모델로 오류 메시지를 다시 전송하는 대신 예외가 throw됩니다.alwaysThrowtruefalsetrue</p>
    <p>
        <pre>
        @Bean
        ToolExecutionExceptionProcessor toolExecutionExceptionProcessor() {
            return new DefaultToolExecutionExceptionProcessor(true);
        }
        </pre>
    </p>
    <p>
        이면 true도구 호출 오류는 호출자가 처리할 수 있도록 예외로 발생합니다. 이면 false오류는 메시지로 변환되어 AI 모델로 다시 전송되어 AI 모델이 오류를 처리하고 대응할 수 있도록 합니다.</p>
</th:block>

</html>